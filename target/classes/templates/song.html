<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Song Bridges</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f4f4f7;margin:0}
        .top-nav-wrap{background:#0f172a;color:#e5e7eb;box-shadow:0 1px 3px rgba(15,23,42,.5)}
        .top-nav{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
        .top-nav-left{font-weight:600;font-size:.95rem}
        .top-nav-links{display:flex;gap:16px;font-size:.9rem}
        .top-nav-links a{color:#cbd5f5;text-decoration:none;padding-bottom:2px;border-bottom:2px solid transparent}
        .top-nav-links a:hover{border-bottom-color:#60a5fa}
        .top-nav-links a.active{color:#fff;border-bottom-color:#facc15}
        .page{max-width:1200px;margin:0 auto;padding:24px 16px 48px}
        .page-header{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:start;margin-bottom:18px}
        h1{font-size:1.8rem;margin:0 0 6px}
        .subtitle{color:#666;font-size:.95rem;margin:0}
        .jump-header{font-size:.9rem;display:flex;flex-direction:column;align-items:flex-end;gap:4px}
        .jump-header select{min-width:140px;font-size:.9rem;border-radius:4px;border:1px solid #d1d5db;padding:4px 6px;background:#fff}
        .songname-row{margin:10px 0 16px;display:grid;grid-template-columns:max-content 1fr;gap:12px;align-items:center}
        .songname-row label{font-weight:600}
        .songname-row input{border:1px solid #d1d5db;border-radius:6px;padding:6px 8px;font-size:.95rem;background:#fff}
        .section-block{background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.07);padding:16px}
        .grid-table{width:100%;border-collapse:collapse;margin-top:8px;font-size:.9rem;table-layout:fixed}
        .grid-table th,.grid-table td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left}
        .grid-table th{background:#f9fafb;font-weight:600}
        .number-cell{width:90px;text-align:center;background:#f9fafb;font-weight:500}
        .file-cell{display:flex;flex-direction:column;gap:6px}
        .filename{font-size:.85rem;color:#374151;background:#f3f4f6;border:1px dashed #d1d5db;border-radius:6px;padding:6px 8px}
        .filename.empty{color:#6b7280;background:#fafafa}
        .timeline-cell{display:grid;grid-template-columns:1fr;gap:8px;align-items:center}
        .timeline-audio{width:100%}
        .timeline-range{width:100%;height:14px}
        .timeline-range::-webkit-slider-runnable-track{height:10px;border-radius:999px;background:#e5e7eb}
        .timeline-range::-webkit-slider-thumb{margin-top:-3px;height:16px;width:16px;border-radius:50%;background:#2563eb;-webkit-appearance:none}
        .timeline-range::-moz-range-track{height:10px;border-radius:999px;background:#e5e7eb}
        .timeline-range::-moz-range-thumb{height:16px;width:16px;border-radius:50%;background:#2563eb;border:none}
        .time-label{font-size:.85rem;color:#6b7280}
        .file-note{font-size:.8rem;color:#6b7280}
        .lock-row{margin-top:18px;padding-top:12px;border-top:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;gap:16px}
        .lock-status-text{font-weight:600}
        .lock-status-text.unlocked{color:#16a34a}
        .lock-status-text.locked{color:#b91c1c}
        .toggle-wrapper{display:flex;align-items:center;gap:8px}
        .toggle-label{font-size:.85rem;color:#374151}
        .toggle{position:relative;width:46px;height:24px}
        .toggle input{display:none}
        .slider{position:absolute;cursor:pointer;inset:0;border-radius:999px;background:#16a34a;transition:.2s}
        .slider::before{content:"";position:absolute;height:18px;width:18px;left:3px;top:3px;border-radius:50%;background:#fff;transition:.2s}
        .toggle.locked .slider{background:#b91c1c}
        .toggle.locked .slider::before{transform:translateX(22px)}
        .btn-primary{border-radius:999px;border:none;padding:8px 18px;font-size:.95rem;font-weight:600;cursor:pointer;background:#2563eb;color:#fff}
        .btn-primary:disabled{opacity:.4;cursor:not-allowed}
        @media (max-width:760px){.page-header{grid-template-columns:1fr}.jump-header{align-items:flex-start}.lock-row{flex-direction:column;align-items:flex-start}}
    </style>
</head>
<body>
<div class="top-nav-wrap">
    <div class="top-nav">
        <div class="top-nav-left">Album Player</div>
        <nav class="top-nav-links">
            <a href="/home">Albums</a>
            <a href="/song" class="active">Songs</a>
            <a href="/meta">Meta</a>
            <a href="/dashboard">Dashboard</a>
        </nav>
    </div>
</div>

<div class="page">
    <div class="page-header">
        <div>
            <h1>Song Bridges</h1>
            <p class="subtitle">Upload MP3 bridge files from <strong>Song 1</strong> to each target song (2–9), then use the timeline bar to play and scrub.</p>
            <div class="songname-row">
                <label for="songNameField">Song name:</label>
                <input id="songNameField" type="text" placeholder="(auto from Home → Section 2 → Song 1)" readonly />
            </div>
        </div>
        <div class="jump-header">
            <label for="songSelect">Jump to song:</label>
            <select id="songSelect" name="songSelect">
                <option value="">Select…</option><option value="1">Song 1*</option><option value="2">Song 2*</option>
                <option value="3">Song 3*</option><option value="4">Song 4*</option><option value="5">Song 5*</option>
                <option value="6">Song 6*</option><option value="7">Song 7*</option><option value="8">Song 8*</option><option value="9">Song 9*</option>
            </select>
        </div>
    </div>

    <section class="section-block">
        <p class="file-note">Files and progress are saved locally when the page is <strong>Locked</strong> (and again when you leave).</p>
        <table class="grid-table">
            <thead>
            <tr>
                <th style="width:110px;">From Song</th>
                <th style="width:110px;">To Song</th>
                <th>Upload MP3</th>
                <th>Timeline</th>
            </tr>
            </thead>
            <tbody>
            <!-- 1 → 2–9; each upload now shows a persistent filename -->
            <tr class="bridge-row" data-from="1" data-to="2">
                <td class="number-cell">1</td><td class="number-cell">2</td>
                <td class="file-cell">
                    <input type="file" accept="audio/mp3,audio/mpeg" class="bridge-file">
                    <div class="filename empty">(no file selected)</div>
                </td>
                <td class="timeline-cell">
                    <audio class="timeline-audio" controls controlslist="nodownload noplaybackrate noremoteplayback"></audio>
                    <input type="range" min="0" max="100" value="0" class="timeline-range">
                    <div class="time-label">0:00 / 0:00</div>
                </td>
            </tr>
            <tr class="bridge-row" data-from="1" data-to="3">
                <td class="number-cell">1</td><td class="number-cell">3</td>
                <td class="file-cell">
                    <input type="file" accept="audio/mp3,audio/mpeg" class="bridge-file">
                    <div class="filename empty">(no file selected)</div>
                </td>
                <td class="timeline-cell">
                    <audio class="timeline-audio" controls controlslist="nodownload noplaybackrate noremoteplayback"></audio>
                    <input type="range" min="0" max="100" value="0" class="timeline-range">
                    <div class="time-label">0:00 / 0:00</div>
                </td>
            </tr>
            <tr class="bridge-row" data-from="1" data-to="4">
                <td class="number-cell">1</td><td class="number-cell">4</td>
                <td class="file-cell">
                    <input type="file" accept="audio/mp3,audio/mpeg" class="bridge-file">
                    <div class="filename empty">(no file selected)</div>
                </td>
                <td class="timeline-cell">
                    <audio class="timeline-audio" controls controlslist="nodownload noplaybackrate noremoteplayback"></audio>
                    <input type="range" min="0" max="100" value="0" class="timeline-range">
                    <div class="time-label">0:00 / 0:00</div>
                </td>
            </tr>
            <tr class="bridge-row" data-from="1" data-to="5">
                <td class="number-cell">1</td><td class="number-cell">5</td>
                <td class="file-cell">
                    <input type="file" accept="audio/mp3,audio/mpeg" class="bridge-file">
                    <div class="filename empty">(no file selected)</div>
                </td>
                <td class="timeline-cell">
                    <audio class="timeline-audio" controls controlslist="nodownload noplaybackrate noremoteplayback"></audio>
                    <input type="range" min="0" max="100" value="0" class="timeline-range">
                    <div class="time-label">0:00 / 0:00</div>
                </td>
            </tr>
            <tr class="bridge-row" data-from="1" data-to="6">
                <td class="number-cell">1</td><td class="number-cell">6</td>
                <td class="file-cell">
                    <input type="file" accept="audio/mp3,audio/mpeg" class="bridge-file">
                    <div class="filename empty">(no file selected)</div>
                </td>
                <td class="timeline-cell">
                    <audio class="timeline-audio" controls controlslist="nodownload noplaybackrate noremoteplayback"></audio>
                    <input type="range" min="0" max="100" value="0" class="timeline-range">
                    <div class="time-label">0:00 / 0:00</div>
                </td>
            </tr>
            <tr class="bridge-row" data-from="1" data-to="7">
                <td class="number-cell">1</td><td class="number-cell">7</td>
                <td class="file-cell">
                    <input type="file" accept="audio/mp3,audio/mpeg" class="bridge-file">
                    <div class="filename empty">(no file selected)</div>
                </td>
                <td class="timeline-cell">
                    <audio class="timeline-audio" controls controlslist="nodownload noplaybackrate noremoteplayback"></audio>
                    <input type="range" min="0" max="100" value="0" class="timeline-range">
                    <div class="time-label">0:00 / 0:00</div>
                </td>
            </tr>
            <tr class="bridge-row" data-from="1" data-to="8">
                <td class="number-cell">1</td><td class="number-cell">8</td>
                <td class="file-cell">
                    <input type="file" accept="audio/mp3,audio/mpeg" class="bridge-file">
                    <div class="filename empty">(no file selected)</div>
                </td>
                <td class="timeline-cell">
                    <audio class="timeline-audio" controls controlslist="nodownload noplaybackrate noremoteplayback"></audio>
                    <input type="range" min="0" max="100" value="0" class="timeline-range">
                    <div class="time-label">0:00 / 0:00</div>
                </td>
            </tr>
            <tr class="bridge-row" data-from="1" data-to="9">
                <td class="number-cell">1</td><td class="number-cell">9</td>
                <td class="file-cell">
                    <input type="file" accept="audio/mp3,audio/mpeg" class="bridge-file">
                    <div class="filename empty">(no file selected)</div>
                </td>
                <td class="timeline-cell">
                    <audio class="timeline-audio" controls controlslist="nodownload noplaybackrate noremoteplayback"></audio>
                    <input type="range" min="0" max="100" value="0" class="timeline-range">
                    <div class="time-label">0:00 / 0:00</div>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="lock-row">
            <div>
                <div>Status: <span id="lockStatusText" class="lock-status-text unlocked">Unlocked</span></div>
                <div class="lock-note">Work is auto-saved when Locked and again when you leave this page.</div>
            </div>
            <div class="toggle-wrapper">
                <span class="toggle-label">Lock page</span>
                <label class="toggle" id="lockToggleWrapper">
                    <input type="checkbox" id="lockToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <button type="button" id="masterSaveBtn" class="btn-primary" disabled>Master Save</button>
        </div>
    </section>
</div>

<script>
(function () {
  // ---------- DOM ----------
  const songNameField = document.getElementById('songNameField');
  const songSelect = document.getElementById('songSelect');
  const tbody = document.querySelector('.grid-table tbody');
  const lockToggle = document.getElementById("lockToggle");
  const lockWrap = document.getElementById("lockToggleWrapper");
  const lockText = document.getElementById("lockStatusText");
  const masterSaveBtn = document.getElementById("masterSaveBtn");

  // ---------- Keys (scoped by currentSong) ----------
  const titleKey = (n)=>`home.section2.song${n}.title`;
  const lockKey  = (n)=>`songPageLockState.${n}`;
  const blobKey  = (n,to)=>`bridge.${n}.${to}`;              // IndexedDB blob
  const posKey   = (n,to)=>`bridge.pos.${n}.${to}`;           // playhead
  const nameKey  = (n,to)=>`bridge.filename.${n}.${to}`;      // filename

  // ---------- IDB ----------
  let db;
  function openDB(){
    return new Promise((res,rej)=>{
      const r=indexedDB.open("albumPlayer",2);
      r.onupgradeneeded=e=>{
        const _db=e.target.result;
        if(!_db.objectStoreNames.contains("songBridges")) _db.createObjectStore("songBridges");
      };
      r.onsuccess=e=>{db=e.target.result;res(db)};
      r.onerror=()=>rej(r.error);
    });
  }
  async function idbSet(key,blob){ if(!db) await openDB(); return new Promise((res,rej)=>{const tx=db.transaction("songBridges","readwrite");tx.objectStore("songBridges").put(blob,key);tx.oncomplete=()=>res(true);tx.onerror=()=>rej(tx.error);});}
  async function idbGet(key){ if(!db) await openDB(); return new Promise((res,rej)=>{const tx=db.transaction("songBridges","readonly");const req=tx.objectStore("songBridges").get(key);req.onsuccess=()=>res(req.result||null);req.onerror=()=>rej(req.error);});}

  // ---------- State ----------
  let currentSong = parseInt(songSelect.value || "1",10) || 1;
  let rowRefs = []; // per render: [{to, fileInput, fileLabel, audio, range, label}...]

  // ---------- Helpers ----------
  function setTitleFor(n){
    try { songNameField.value = localStorage.getItem(titleKey(n)) || ""; } catch(e){ songNameField.value=""; }
  }
  function applyLockUI(locked){
    if(locked){
      lockWrap.classList.add("locked");
      lockText.textContent="Locked";
      lockText.classList.remove("unlocked"); lockText.classList.add("locked");
      masterSaveBtn.disabled=false;
    }else{
      lockWrap.classList.remove("locked");
      lockText.textContent="Unlocked";
      lockText.classList.remove("locked"); lockText.classList.add("unlocked");
      masterSaveBtn.disabled=true;
    }
    // Disable inputs when locked
    rowRefs.forEach(r=>{
      r.fileInput.disabled = locked;
      r.range.disabled = locked;
      r.fileInput.style.cursor = locked ? "not-allowed" : "";
      r.range.style.cursor = locked ? "not-allowed" : "";
    });
  }
  function isLocked(n){
    return localStorage.getItem(lockKey(n))==="1";
  }
  function setLocked(n,locked){
    try{ localStorage.setItem(lockKey(n), locked?"1":"0"); }catch(e){}
  }
  function formatTime(s){ if(!isFinite(s)) return "0:00"; const m=Math.floor(s/60),t=Math.floor(s%60); return m+":"+(t<10?"0"+t:t); }

  async function saveProgress(n){
    rowRefs.forEach(ref=>{
      const t = ref.to;
      const a = ref.audio;
      if(a && isFinite(a.currentTime)){
        try{ localStorage.setItem(posKey(n,t), String(a.currentTime||0)); }catch(e){}
      }
    });
    // blobs are saved on upload; filenames saved on upload
  }

  async function restoreRow(n, ref){
    const to = ref.to;
    // blob
    try{
      const blob = await idbGet(blobKey(n,to));
      if(blob){ ref.audio.src = URL.createObjectURL(blob); }
    }catch(e){}
    // filename
    try{
      const fn = localStorage.getItem(nameKey(n,to)) || "";
      if(fn){ ref.fileLabel.textContent = fn; ref.fileLabel.classList.remove("empty"); }
      else  { ref.fileLabel.textContent = "(no file selected)"; ref.fileLabel.classList.add("empty"); }
    }catch(e){}
    // playhead
    try{
      const pos = parseFloat(localStorage.getItem(posKey(n,to))||"0");
      if(isFinite(pos)&&pos>0){
        ref.audio.addEventListener("loadedmetadata",()=>{
          if(ref.audio.duration && ref.audio.duration!==Infinity){
            ref.audio.currentTime = Math.min(pos, ref.audio.duration-0.25);
          }
        },{once:true});
      }
    }catch(e){}
  }

  function buildRowHTML(from,to){
    return `
      <tr class="bridge-row" data-from="${from}" data-to="${to}">
        <td class="number-cell">${from}</td>
        <td class="number-cell">${to}</td>
        <td class="file-cell">
          <input type="file" accept="audio/mp3,audio/mpeg" class="bridge-file">
          <div class="filename empty">(no file selected)</div>
        </td>
        <td class="timeline-cell">
          <audio class="timeline-audio" controls controlslist="nodownload noplaybackrate noremoteplayback"></audio>
          <input type="range" min="0" max="100" value="0" class="timeline-range">
          <div class="time-label">0:00 / 0:00</div>
        </td>
      </tr>
    `;
  }

  async function renderForSong(n){
    // Build rows: From n → all others 1..9 except n
    const targets = [];
    for(let t=1;t<=9;t++) if(t!==n) targets.push(t);
    tbody.innerHTML = targets.map(t=>buildRowHTML(n,t)).join("");

    // Wire refs
    rowRefs = [...tbody.querySelectorAll(".bridge-row")].map(row=>{
      const to = parseInt(row.getAttribute("data-to"),10);
      return {
        to,
        fileInput: row.querySelector(".bridge-file"),
        fileLabel: row.querySelector(".filename"),
        audio:     row.querySelector(".timeline-audio"),
        range:     row.querySelector(".timeline-range"),
        label:     row.querySelector(".time-label"),
      };
    });

    // Restore row state
    await Promise.all(rowRefs.map(r=>restoreRow(n,r)));

    // Wire events
    rowRefs.forEach(ref=>{
      ref.fileInput.addEventListener("change", async ()=>{
        if(lockToggle.checked){
          ref.fileInput.value="";
          alert("Unlock the page to change files.");
          return;
        }
        const file = ref.fileInput.files && ref.fileInput.files[0];
        if(!file) return;
        try{
          await idbSet(blobKey(n,ref.to), file);
          localStorage.setItem(nameKey(n,ref.to), file.name);
          ref.audio.src = URL.createObjectURL(file);
          ref.audio.load();
          ref.fileLabel.textContent = file.name;
          ref.fileLabel.classList.remove("empty");
        }catch(e){
          alert("Could not save locally (storage limit?). Will play but may not persist.");
          ref.audio.src = URL.createObjectURL(file);
          ref.audio.load();
          ref.fileLabel.textContent = file.name;
          ref.fileLabel.classList.remove("empty");
        }
      });

      ref.audio.addEventListener("timeupdate",()=>{
        if(!ref.audio.duration || ref.audio.duration===Infinity) return;
        const pct = (ref.audio.currentTime/ref.audio.duration)*100;
        ref.range.value = pct;
        ref.label.textContent = formatTime(ref.audio.currentTime)+" / "+formatTime(ref.audio.duration);
      });
      ref.audio.addEventListener("loadedmetadata",()=>{
        ref.label.textContent = "0:00 / "+formatTime(ref.audio.duration);
      });
      ref.range.addEventListener("input",()=>{
        if(lockToggle.checked) return;
        if(!ref.audio.duration || ref.audio.duration===Infinity) return;
        const pct = ref.range.value/100;
        ref.audio.currentTime = pct * ref.audio.duration;
      });
    });

    // Title + Lock UI for this song
    setTitleFor(n);
    const locked = isLocked(n);
    lockToggle.checked = locked;
    applyLockUI(locked);
  }

  // ---------- Lock handlers ----------
  lockToggle.addEventListener("change", async ()=>{
    const locked = lockToggle.checked;
    applyLockUI(locked);
    setLocked(currentSong, locked);
    if(locked){ await saveProgress(currentSong); }
  });
  masterSaveBtn.addEventListener("click", async ()=>{
    if(masterSaveBtn.disabled) return;
    if(!confirm("Are you sure you want to save? This is last time.")) return;
    if(!confirm("Do you want to save this song page? No going back from here.")) return;
    await saveProgress(currentSong);
    alert("Song page saved locally. (Hook to backend to persist server-side.)");
  });
  window.addEventListener("pagehide", async ()=>{ if(lockToggle.checked) await saveProgress(currentSong); });
  document.addEventListener("visibilitychange", async ()=>{ if(document.hidden && lockToggle.checked) await saveProgress(currentSong); });

  // ---------- Song selector ----------
  songSelect.addEventListener("change", async ()=>{
    // snapshot current if locked
    if(lockToggle.checked){ await saveProgress(currentSong); }
    currentSong = parseInt(songSelect.value||"1",10)||1;
    await renderForSong(currentSong);
  });

  // ---------- Init ----------
  (async function init(){
    // default selection if empty
    if(!songSelect.value){ songSelect.value = String(currentSong); }
    await renderForSong(currentSong);
  })();
})();
</script>
